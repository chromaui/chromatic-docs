---
layout: "../../layouts/Layout.astro"
title: Cypress (beta)
description: Chromatic E2E Visual Tests capture snapshots of pages visited during Cypress tests.
sidebar: { order: 18 }
---

import { TabItem, Tabs } from "../../components/Tabs";

# E2E Visual Tests for Cypress (beta)

Chromatic E2E Visual Tests lets you bring Chromatic's visual testing toolkit into your existing Cypress workflow. You can use Chromatic to capture snapshots of pages visited during Cypress testsâ€”including DOM, styles, and assetsâ€”and then review and approve them in the Chromatic UI.

<div class="aside">
  Note: with the beta release we've made some changes to the setup for
  Chromatic's E2E Visual Tests feature. Please refer to the [upgrade
  guide](/docs/e2e-upgrade-guide) for more details.
</div>

## Getting started

### 1. Set up a Chromatic project

If your repository already has an associated Chromatic project, you can set up an additional Chromatic project to test the Archive Storybook using the [instructions for monorepo support](/docs/monorepos#run-chromatic-for-each-subproject).

Otherwise, follow [these sign up instructions](/docs/setup#sign-up) to create a new Chromatic project.

<div class="aside">
  ðŸ‘‰ Take note of the project token for the new project. You'll need it in the
  next steps.
</div>

### 2. Install dependencies

Run the following command to install `@chromatic-com/cypress` and related dependencies.

<Tabs>
  <TabItem label="yarn">
    ```shell
    yarn add --dev chromatic @chromatic-com/cypress
    ```
  </TabItem>

  <TabItem label="npm">
    ```shell
    npm install --save-dev chromatic @chromatic-com/cypress
    ```
  </TabItem>
</Tabs>

### 3. Add Chromatic to Cypress

Add the following to your `cypress/support/e2e.js` file:

```js
import "@chromatic-com/cypress/support";
```

Install our plugin in your `cypress.config.js` file:

```js
const { defineConfig } = require("cypress");
const { installPlugin } = require("@chromatic-com/cypress");

module.exports = defineConfig({
  e2e: {
    setupNodeEvents(on, config) {
      installPlugin(on, config);
    },
  },
});
```

### 4. Run Cypress as usual

Prepend your command with the following environment variable, which defines what port Chrome Devtools Protocol should listen to:

<Tabs>
  <TabItem label="yarn">
    ```shell
    ELECTRON_EXTRA_LAUNCH_ARGS=--remote-debugging-port=9222 yarn cypress run
    ```
  </TabItem>

  <TabItem label="npm">
    ```shell
    ELECTRON_EXTRA_LAUNCH_ARGS=--remote-debugging-port=9222 npx cypress run
    ```
  </TabItem>
</Tabs>

By default, `9222` is the port that's being listened to. You can customize this with any other port number, as long as it's not already in use.

### 5. Run a Chromatic build

You can use either the Chromatic CLI or the GitHub Action to run a build.

#### Chromatic CLI

Use the Chromatic CLI to run a build (using the token you noted above)

```shell
CHROMATIC_ARCHIVE_LOCATION=./cypress/downloads npx chromatic --cypress -t=<TOKEN>
```

#### GitHub Action

Use the GitHub Action with the `cypress` flag to run a build.

```yaml
- name: Publish to Chromatic
  uses: chromaui/action@latest
  with:
    cypress: true
    projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

# With env vars

- name: Publish to Chromatic
  uses: chromaui/action@latest
  with:
    cypress: true
    projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
  env:
    CHROMATIC_ARCHIVE_LOCATION=./custom/dir
```

---

## Taking manual snapshots

A snapshot is automatically taken at the end of every test, whether is passes or fails. But you can also programmatically take manual snapshots at specific points in your tests using the `takeSnapshot` function inside your test runs:

```js
describe("My First Test", () => {
  it("Visits the Kitchen Sink", () => {
    // ðŸ‘‡ navigate to target page
    cy.visit("https://example.cypress.io");

    // ðŸ“¸ tell Chromatic to take a snapshot of the initial page state
    cy.takeSnapshot();

    // ðŸ‘‡ finish the test by opening the dropdown menu
    cy.get(".dropdown:first-of-type > .dropdown-toggle").click();

    // ðŸ“¸ Chromatic automatically takes a snapshot here, at the end of the test
  });
});
```

---

## Configuration

You can further configure both your Cypress and Chromatic tests with the options described in the following sections.

### Cypress options

Cypress can be configured with [Cypress environment variables](https://docs.cypress.io/guides/guides/environment-variables).

Setting options globally can be done in your Cypress config file as follows:

```ts
// cypress.config.ts
export default defineConfig({
  env: {
    disableAutoSnapshot: true
  },

  // other setup...
});
```
Options can also be overridden at the test level:

```ts
// some-test.cy.ts
it('A test that does something', { env: { disableAutoSnapshot: true } }, () => {
  cy.visit('https://some-url.com');
});
```

### E2E options

These options control how the Chromatic archive fixture behaves.

| Option                   | Type            | Description                                                                                                                                                                          |
| ------------------------ | --------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| `disableAutoSnapshot`    | `boolean`       | When `true`, will disable the snapshot that happens automatically at the end of a test when using the Chromatic test fixture.                                                        |
| `resourceArchiveTimeout` | `number`        | Maximum amount of time that each test will wait for the network to be idle while archiving resources.                                                                                |
| `assetDomains`           | `array[string]` | A list of domains external to the test location that you want Chromatic to also capture assets from, e.g., <code style="display: inline;">['other-domain.com','our-cdn.com']</code>. |

### Chromatic options

These options control how Chromatic behaves concerning the stories of your archives.

| Option                    | Type      | Chromatic Docs                                                          |
| ------------------------- | --------- | ----------------------------------------------------------------------- |
| `delay`                   | `number`  | [Delay](/docs/delay/)                                                   |
| `diffIncludeAntiAliasing` | `boolean` | [Threshold for changes](/docs/threshold#anti-aliasing)                  |
| `diffThreshold`           | `number`  | [Threshold for changes](/docs/threshold#setting-the-threshold)          |
| `forcedColors`            | `string`  | [Media Features](/docs/media-features#test-high-contrast-color-schemes) |
| `pauseAnimationAtEnd`     | `boolean` | [Animations](/docs/animations#css-animations)                           |
| `prefersReducedMotion`    | `string`  | [Media Features](/docs/media-features#verify-reduced-motion-animations) |

### Environment variables

Some options can be configured through environment variables.

| Environment variable         | Description                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `CHROMATIC_ARCHIVE_LOCATION` | If you have configured your project's [`downloadsFolder`](https://docs.cypress.io/guides/references/configuration#Downloads) option to be different than the default, you must set the `CHROMATIC_ARCHIVE_LOCATION` environment variable to the same value. This must be done when starting the Storybook and when building it on CI. This ensures that the Archive Storybook can find the [archives](#what-are-archives) generated by the Test Archiver. |
